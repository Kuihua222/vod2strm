<!-- 文件：index.html - 唯一前端页面 -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VOD转STRM工具</title>
    <style>
        /* 基础样式 */
        body { font-family: sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .hidden { display: none !important; }
        
        /* 导航 */
        .nav { background: #2c3e50; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .nav a { color: white; margin-right: 20px; text-decoration: none; font-weight: bold; cursor: pointer; }
        .nav a:hover { text-decoration: underline; }
        
        /* 页面通用 */
        .page { background: white; padding: 20px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        /* 海报墙 */
        .filter-buttons { margin-bottom: 15px; }
        .filter-btn { padding: 8px 16px; margin-right: 10px; border: 1px solid #ddd; background: white; cursor: pointer; }
        .filter-btn.active { background: #3498db; color: white; border-color: #3498db; }
        .poster-wall { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; }
        .poster-item { text-align: center; cursor: pointer; transition: transform 0.2s; }
        .poster-item:hover { transform: scale(1.05); }
        .poster-img { width: 100%; height: 250px; object-fit: cover; border-radius: 5px; background: #eee; }
        .poster-title { margin-top: 8px; font-weight: bold; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .poster-meta { color: #666; font-size: 0.9em; margin-top: 4px; }
        
        /* 模态框（详情/设置） */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal { background: white; padding: 25px; border-radius: 8px; min-width: 500px; max-width: 90%; max-height: 80%; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .modal-close { background: none; border: none; font-size: 1.5em; cursor: pointer; }
        
        /* 播放源列表 */
        .source-list { margin: 15px 0; }
        .source-item { padding: 10px; border: 1px solid #eee; margin-bottom: 8px; border-radius: 4px; display: flex; justify-content: space-between; }
        .source-item.direct { border-left: 4px solid #2ecc71; }
        .source-btn { padding: 5px 10px; background: #3498db; color: white; border: none; border-radius: 3px; cursor: pointer; }
        
        /* 表单 */
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .form-btn { padding: 10px 20px; background: #2ecc71; color: white; border: none; border-radius: 4px; cursor: pointer; }
        
        /* STRM管理列表 */
        .strm-list { margin-top: 15px; }
        .strm-item { padding: 12px; border: 1px solid #eee; margin-bottom: 10px; border-radius: 5px; }
        .strm-header { display: flex; justify-content: space-between; }
        .strm-url { font-family: monospace; background: #f9f9f9; padding: 8px; margin: 8px 0; border-radius: 3px; word-break: break-all; font-size: 0.9em; }
        .strm-actions button { margin-right: 8px; padding: 5px 10px; }
    </style>
</head>
<body>
    <div class="container">
        <!-- 导航栏 -->
        <div class="nav">
            <a onclick="showPage('home')">海报墙</a>
            <a onclick="showPage('settings')">系统设置</a>
            <a onclick="showPage('my-strm')">我的STRM</a>
        </div>
        
        <!-- 页面1：海报墙主页 -->
        <div id="page-home" class="page">
            <h2>VOD资源海报墙</h2>
            <div class="filter-buttons">
                <button class="filter-btn active" onclick="filterType('all')">全部</button>
                <button class="filter-btn" onclick="filterType('movie')">电影</button>
                <button class="filter-btn" onclick="filterType('series')">剧集</button>
            </div>
            <div class="search-box">
                <input type="text" id="search-input" placeholder="输入影视名称搜索..." style="width:300px; padding:8px;">
                <button onclick="doSearch()" style="padding:8px 15px;">搜索</button>
            </div>
            <div id="poster-wall" class="poster-wall"><!-- 海报动态加载到这里 --></div>
        </div>
        
        <!-- 页面2：系统设置 -->
        <div id="page-settings" class="page hidden">
            <h2>系统设置</h2>
            <p>在此配置VOD资源站的API地址，这是所有影视数据的来源。</p>
            <div class="form-group">
                <label class="form-label">VOD资源站API地址</label>
                <input type="text" id="vod-api-url" class="form-input" placeholder="例如：http://caiji.dyttzyapi.com/api.php/provide/vod/">
            </div>
            <button onclick="saveConfig()" class="form-btn">保存配置</button>
            <p id="config-message" style="margin-top:10px; color:green;"></p>
        </div>
        
        <!-- 页面3：我的STRM -->
        <div id="page-my-strm" class="page hidden">
            <h2>已生成的STRM文件</h2>
            <p>您之前生成的所有STRM记录将在此列出，可以重新下载或尝试更新播放地址。</p>
            <div id="strm-list" class="strm-list"><!-- 记录动态加载到这里 --></div>
        </div>
    </div>
    
    <!-- 模态框：影视详情与STRM生成 -->
    <div id="modal-detail" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modal-title">选择播放源并生成STRM</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modal-content">
                <!-- 内容由JS动态填充 -->
            </div>
        </div>
    </div>

    <script>
        // ---------- 全局配置 ----------
        // 重要！将此处替换为你的Vercel部署后的实际域名
        const API_BASE_URL = 'https://vod2strm.vercel.app/';
        let currentType = 'all';
        let currentSearchResults = [];
        
        // ---------- 页面导航 ----------
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.getElementById(`page-${pageId}`).classList.remove('hidden');
            if (pageId === 'my-strm') loadStrmRecords();
            if (pageId === 'settings') loadConfig();
        }
        
        // ---------- 海报墙功能 ----------
        function filterType(type) {
            currentType = type;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderPosters();
        }
        
        function doSearch() {
            const keyword = document.getElementById('search-input').value.trim();
            if (!keyword) {
                alert('请输入搜索关键词');
                return;
            }
            fetch(`${API_BASE_URL}/search`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ keyword, type: currentType })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    currentSearchResults = data.data;
                    renderPosters();
                } else {
                    alert('搜索失败: ' + (data.error || '未知错误'));
                }
            });
        }
        
        function renderPosters() {
            const wall = document.getElementById('poster-wall');
            let html = '';
            const filtered = currentSearchResults.filter(item => 
                currentType === 'all' || item.type === currentType
            );
            filtered.forEach(item => {
                html += `
                    <div class="poster-item" onclick="showDetail('${item.id}')">
                        <img src="${item.pic || 'https://via.placeholder.com/180x250?text=No+Image'}" class="poster-img" alt="${item.name}">
                        <div class="poster-title">${item.name}</div>
                        <div class="poster-meta">${item.year || ''} · ${item.type === 'series' ? '剧集' : '电影'}</div>
                    </div>
                `;
            });
            wall.innerHTML = html || '<p>未找到相关资源，请尝试其他关键词。</p>';
        }
        
        // ---------- 详情与STRM生成 ----------
        function showDetail(resourceId) {
            const resource = currentSearchResults.find(item => item.id === resourceId);
            if (!resource) return;
            
            document.getElementById('modal-title').textContent = `生成STRM: ${resource.name}`;
            const modalContent = document.getElementById('modal-content');
            
            // 构建播放源选择列表
            let sourcesHtml = '<div class="source-list">';
            resource.sources.forEach((src, idx) => {
                sourcesHtml += `
                    <div class="source-item ${src.isDirect ? 'direct' : ''}">
                        <div>
                            <strong>${src.source}</strong> - ${src.label}<br>
                            <small style="color:#666; font-family:monospace;">${src.url.substring(0, 60)}...</small>
                        </div>
                        <button class="source-btn" onclick="generateStrm('${resourceId}', ${idx})">生成STRM</button>
                    </div>
                `;
            });
            sourcesHtml += '</div>';
            modalContent.innerHTML = sourcesHtml;
            document.getElementById('modal-detail').classList.remove('hidden');
        }
        
        function closeModal() {
            document.getElementById('modal-detail').classList.add('hidden');
        }
        
        function generateStrm(resourceId, sourceIndex) {
            const resource = currentSearchResults.find(item => item.id === resourceId);
            const source = resource.sources[sourceIndex];
            
            fetch(`${API_BASE_URL}/generate-strm`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    resourceName: resource.name,
                    resourceType: resource.type,
                    playUrl: source.url,
                    year: resource.year
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert('STRM生成成功！即将开始下载...');
                    // 触发下载
                    window.open(`${API_BASE_URL}/download-strm?id=${data.recordId}`, '_blank');
                    closeModal();
                } else {
                    alert('生成失败');
                }
            });
        }
        
        // ---------- 系统设置 ----------
        function loadConfig() {
            fetch(`${API_BASE_URL}/config`)
            .then(r => r.json())
            .then(data => {
                document.getElementById('vod-api-url').value = data.vodApiUrl || '';
            });
        }
        
        function saveConfig() {
            const url = document.getElementById('vod-api-url').value.trim();
            fetch(`${API_BASE_URL}/config`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ vodApiUrl: url })
            })
            .then(r => r.json())
            .then(data => {
                const msg = document.getElementById('config-message');
                if (data.success) {
                    msg.textContent = '配置保存成功！';
                    msg.style.color = 'green';
                } else {
                    msg.textContent = '保存失败，请重试。';
                    msg.style.color = 'red';
                }
            });
        }
        
        // ---------- STRM管理 ----------
        function loadStrmRecords() {
            fetch(`${API_BASE_URL}/my-strm`)
            .then(r => r.json())
            .then(data => {
                const container = document.getElementById('strm-list');
                if (!data.success || data.data.length === 0) {
                    container.innerHTML = '<p>暂无STRM生成记录。</p>';
                    return;
                }
                let html = '';
                data.data.forEach(record => {
                    html += `
                        <div class="strm-item">
                            <div class="strm-header">
                                <strong>${record.name}</strong>
                                <span>${new Date(record.generatedAt).toLocaleString()}</span>
                            </div>
                            <div>类型: ${record.type === 'series' ? '剧集' : '电影'}</div>
                            <div class="strm-url">地址: ${record.url.substring(0, 80)}...</div>
                            <div class="strm-actions">
                                <button onclick="downloadAgain('${record.id}')">重新下载</button>
                                <button onclick="refreshUrl('${record.id}')">查找新源</button>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            });
        }
        
        function downloadAgain(recordId) {
            window.open(`${API_BASE_URL}/download-strm?id=${recordId}`, '_blank');
        }
        
        function refreshUrl(recordId) {
            fetch(`${API_BASE_URL}/refresh-url`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: recordId })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success && data.newUrl) {
                    alert(`找到新地址，可以重新生成STRM。`);
                } else {
                    alert('暂未找到可用的新播放地址。');
                }
            });
        }
        
        // 页面初始化
        showPage('home');
    </script>
</body>
</html>
