<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VOD影视聚合 - STRM生成器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background-color: #1a1a1a;
            color: #fff;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid #333;
            margin-bottom: 20px;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #e50914;
        }
        
        .nav {
            display: flex;
            gap: 20px;
        }
        
        .nav a {
            color: #fff;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        .nav a:hover, .nav a.active {
            background-color: #e50914;
        }
        
        .section-title {
            font-size: 24px;
            margin-bottom: 20px;
            color: #e50914;
        }
        
        .poster-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .poster-item {
            background-color: #2a2a2a;
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }
        
        .poster-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(229, 9, 20, 0.3);
        }
        
        .poster-img {
            width: 100%;
            height: 280px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 24px;
            text-align: center;
            padding: 20px;
        }
        
        .poster-info {
            padding: 12px;
        }
        
        .poster-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .poster-meta {
            color: #aaa;
            font-size: 14px;
        }
        
        .detail-container {
            display: flex;
            gap: 30px;
            margin-top: 20px;
        }
        
        .poster-large {
            width: 300px;
            height: 450px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 36px;
            border-radius: 8px;
        }
        
        .detail-info {
            flex: 1;
        }
        
        .detail-title {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .detail-meta {
            color: #aaa;
            margin-bottom: 20px;
            font-size: 16px;
        }
        
        .sources-list {
            margin-top: 30px;
        }
        
        .sources-title {
            font-size: 20px;
            margin-bottom: 15px;
            color: #e50914;
        }
        
        .source-item {
            background-color: #2a2a2a;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .source-item:hover, .source-item.selected {
            background-color: #3a3a3a;
            border-left: 4px solid #e50914;
        }
        
        .source-name {
            font-weight: bold;
            color: #fff;
        }
        
        .source-desc {
            color: #aaa;
            margin-top: 5px;
            font-size: 14px;
        }
        
        .source-url {
            color: #64b5f6;
            word-break: break-all;
            margin-top: 5px;
            font-size: 12px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: #e50914;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #f40612;
        }
        
        .btn-secondary {
            background-color: #333;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #444;
        }
        
        .config-form {
            background-color: #2a2a2a;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #444;
            border-radius: 4px;
            background-color: #1a1a1a;
            color: white;
            font-size: 16px;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #e50914;
        }
        
        .strm-list {
            margin-top: 20px;
        }
        
        .strm-item {
            background-color: #2a2a2a;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 4px solid #e50914;
        }
        
        .strm-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .strm-meta {
            color: #aaa;
            margin-bottom: 10px;
        }
        
        .strm-url {
            color: #64b5f6;
            word-break: break-all;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .strm-actions {
            display: flex;
            gap: 10px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #aaa;
        }
        
        .spinner {
            border: 4px solid rgba(229, 9, 20, 0.1);
            border-left: 4px solid #e50914;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: #2a2a2a;
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            position: relative;
        }
        
        .modal-title {
            font-size: 24px;
            margin-bottom: 20px;
            color: #e50914;
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #aaa;
        }
        
        .modal-close:hover {
            color: white;
        }
        
        @media (max-width: 768px) {
            .poster-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .detail-container {
                flex-direction: column;
            }
            
            .poster-large {
                width: 100%;
                height: 300px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">VOD-STRM</div>
            <div class="nav">
                <a href="#" class="nav-item active" data-page="home">首页</a>
                <a href="#" class="nav-item" data-page="strm">我的STRM</a>
                <a href="#" class="nav-item" data-page="config">系统设置</a>
            </div>
        </header>

        <main id="main-content">
            <div id="home-page">
                <h1 class="section-title">热门影视</h1>
                <div class="poster-grid" id="poster-grid">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>正在加载影视资源...</p>
                    </div>
                </div>
            </div>

            <div id="strm-page" style="display: none;">
                <h1 class="section-title">我的STRM文件</h1>
                <div class="action-buttons">
                    <button class="btn btn-primary" id="download-all-btn">打包下载所有STRM</button>
                    <button class="btn btn-secondary" id="refresh-strm-btn">刷新列表</button>
                </div>
                <div class="strm-list" id="strm-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>正在加载STRM文件...</p>
                    </div>
                </div>
            </div>

            <div id="config-page" style="display: none;">
                <h1 class="section-title">系统设置</h1>
                <div class="config-form">
                    <div class="form-group">
                        <label for="vod-api-url">VOD资源API地址</label>
                        <input type="text" id="vod-api-url" placeholder="请输入VOD API地址">
                        <small style="color: #aaa; display: block; margin-top: 5px;">示例: https://caiji.maotaizy.cc/api.php/provide/vod/from/mtm3u8/at/josn/</small>
                    </div>
                    <div class="form-group">
                        <label for="player-scheme">播放器跳转协议</label>
                        <input type="text" id="player-scheme" placeholder="SenPlayer://x-callback-url/play?url=">
                        <small style="color: #aaa; display: block; margin-top: 5px;">为空时使用默认浏览器播放</small>
                    </div>
                    <div class="form-group">
                        <label for="emby-library-type">EMBY媒体库类型</label>
                        <select id="emby-library-type">
                            <option value="movie">电影</option>
                            <option value="tv">剧集</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="emby-library-name">EMBY媒体库名称</label>
                        <input type="text" id="emby-library-name" placeholder="Movies 或 TV Shows">
                        <small style="color: #aaa; display: block; margin-top: 5px;">电影库通常为Movies，剧集库为TV Shows</small>
                    </div>
                    <button class="btn btn-primary" id="save-config-btn">保存配置</button>
                </div>
            </div>
        </main>
    </div>

    <div class="modal" id="detail-modal">
        <div class="modal-content">
            <span class="modal-close" id="close-modal">&times;</span>
            <h2 class="modal-title" id="modal-title">影视详情</h2>
            <div id="modal-content">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>正在加载详情...</p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="edit-strm-modal">
        <div class="modal-content">
            <span class="modal-close" id="close-edit-modal">&times;</span>
            <h2 class="modal-title" id="edit-modal-title">编辑STRM文件</h2>
            <div class="form-group">
                <label>影视名称</label>
                <input type="text" id="edit-strm-name" readonly>
            </div>
            <div class="form-group">
                <label>当前播放地址</label>
                <input type="text" id="edit-strm-url" style="color: #64b5f6;">
            </div>
            <div class="form-group">
                <label>新播放地址</label>
                <input type="text" id="new-strm-url" placeholder="输入新的播放地址或选择新源">
            </div>
            <div class="action-buttons">
                <button class="btn btn-primary" id="find-new-source-btn">查找最新可用源</button>
                <button class="btn btn-secondary" id="save-strm-btn">保存更改</button>
            </div>
            <div id="new-sources-container" style="margin-top: 20px; display: none;">
                <h3 style="margin-bottom: 10px; color: #e50914;">可用新源</h3>
                <div id="new-sources-list"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        // ======================
        // 配置管理
        // ======================
        class ConfigManager {
            static DEFAULT_CONFIG = {
                vodApiUrl: 'https://caiji.maotaizy.cc/api.php/provide/vod/from/mtm3u8/at/josn/',
                playerScheme: 'SenPlayer://x-callback-url/play?url=',
                embyLibraryType: 'movie',
                embyLibraryName: 'Movies'
            };

            static getConfig() {
                const config = localStorage.getItem('vod-strm-config');
                return config ? JSON.parse(config) : this.DEFAULT_CONFIG;
            }

            static saveConfig(config) {
                localStorage.setItem('vod-strm-config', JSON.stringify(config));
            }

            static init() {
                const config = this.getConfig();
                
                document.getElementById('vod-api-url').value = config.vodApiUrl;
                document.getElementById('player-scheme').value = config.playerScheme || '';
                document.getElementById('emby-library-type').value = config.embyLibraryType;
                document.getElementById('emby-library-name').value = config.embyLibraryName || (config.embyLibraryType === 'movie' ? 'Movies' : 'TV Shows');
                
                document.getElementById('save-config-btn').addEventListener('click', () => {
                    const newConfig = {
                        vodApiUrl: document.getElementById('vod-api-url').value.trim(),
                        playerScheme: document.getElementById('player-scheme').value.trim(),
                        embyLibraryType: document.getElementById('emby-library-type').value,
                        embyLibraryName: document.getElementById('emby-library-name').value.trim()
                    };
                    
                    if (!newConfig.vodApiUrl) {
                        alert('VOD API地址不能为空！');
                        return;
                    }
                    
                    this.saveConfig(newConfig);
                    alert('配置保存成功！');
                });
            }
        }

        // ======================
        // STRM文件管理
        // ======================
        class StrmManager {
            static getStrmFiles() {
                const files = localStorage.getItem('vod-strm-files');
                return files ? JSON.parse(files) : [];
            }

            static saveStrmFiles(files) {
                localStorage.setItem('vod-strm-files', JSON.stringify(files));
            }

            static addStrmFile(strmData) {
                const files = this.getStrmFiles();
                files.push(strmData);
                this.saveStrmFiles(files);
            }

            static updateStrmFile(index, updatedData) {
                const files = this.getStrmFiles();
                if (files[index]) {
                    files[index] = { ...files[index], ...updatedData };
                    this.saveStrmFiles(files);
                }
            }

            static generateStrmContent(url) {
                return url;
            }

            static generateEmbyCompatiblePath(movieData, episode = null) {
                const config = ConfigManager.getConfig();
                const name = movieData.vod_name || movieData.name;
                const year = movieData.vod_year || '2025';
                
                if (config.embyLibraryType === 'movie') {
                    return `${config.embyLibraryName}/${name} (${year})/${name} (${year}).strm`;
                } else {
                    const season = episode ? `Season ${String(episode.season || 1).padStart(2, '0')}` : 'Season 01';
                    const episodeNum = episode ? episode.number : 1;
                    const episodeStr = `S${String(episode ? episode.season : 1).padStart(2, '0')}E${String(episodeNum).padStart(2, '0')}`;
                    
                    return `${config.embyLibraryName}/${name} (${year})/${season}/${name} - ${episodeStr}.strm`;
                }
            }
        }

        // ======================
        // VOD API 客户端
        // ======================
        class VodApiClient {
            static async fetchResources(searchTerm = '', page = 1, limit = 20) {
                const config = ConfigManager.getConfig();
                const url = new URL(config.vodApiUrl);
                
                url.searchParams.append('ac', 'list');
                if (searchTerm) {
                    url.searchParams.append('wd', searchTerm);
                }
                url.searchParams.append('pg', page);
                url.searchParams.append('t', '');
                url.searchParams.append('h', limit);
                
                try {
                    const response = await fetch(url.toString());
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('Error fetching VOD resources:', error);
                    return {
                        code: 0,
                        msg: '请求失败',
                        list: [],
                        pagecount: 0,
                        total: 0
                    };
                }
            }

            static async fetchDetail(vodId) {
                const config = ConfigManager.getConfig();
                const url = new URL(config.vodApiUrl);
                
                url.searchParams.append('ac', 'detail');
                url.searchParams.append('ids', vodId);
                
                try {
                    const response = await fetch(url.toString());
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('Error fetching VOD detail:', error);
                    return {
                        code: 0,
                        msg: '请求失败',
                        list: []
                    };
                }
            }

            static parsePlaySources(playFrom, playUrl) {
                const sources = [];
                const playFroms = playFrom.split('$$$');
                const playUrls = playUrl.split('$$$');
                
                for (let i = 0; i < Math.min(playFroms.length, playUrls.length); i++) {
                    const sourceName = playFroms[i].trim();
                    let sourceUrl = playUrls[i].trim();
                    
                    if (sourceUrl.endsWith('##')) {
                        sourceUrl = sourceUrl.slice(0, -2);
                    }
                    
                    if (sourceUrl && sourceUrl !== '#') {
                        if (sourceUrl.includes('#')) {
                            const episodes = sourceUrl.split('#').filter(ep => ep && ep.includes('$'));
                            episodes.forEach(ep => {
                                const [title, url] = ep.split('$');
                                if (url) {
                                    sources.push({
                                        name: sourceName,
                                        title: title.trim(),
                                        url: url.trim(),
                                        type: 'episode'
                                    });
                                }
                            });
                        } else if (sourceUrl.includes('$')) {
                            const parts = sourceUrl.split('$');
                            const quality = parts[0] || '默认';
                            const url = parts[1] || parts[0];
                            if (url) {
                                sources.push({
                                    name: sourceName,
                                    title: quality.trim(),
                                    url: url.trim(),
                                    type: parts.length > 1 ? 'movie' : 'direct'
                                });
                            }
                        } else {
                            sources.push({
                                name: sourceName,
                                title: '默认',
                                url: sourceUrl,
                                type: 'direct'
                            });
                        }
                    }
                }
                
                return sources;
            }
        }

        // ======================
        // 页面渲染
        // ======================
        class PageRenderer {
            static renderHomePage(movies = []) {
                const grid = document.getElementById('poster-grid');
                
                if (movies.length === 0) {
                    grid.innerHTML = `
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>暂无影视资源，稍后再试</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                movies.forEach(movie => {
                    html += `
                        <div class="poster-item" data-id="${movie.vod_id}">
                            <div class="poster-img">${this.getInitials(movie.vod_name)}</div>
                            <div class="poster-info">
                                <div class="poster-title">${this.truncateText(movie.vod_name, 12)}</div>
                                <div class="poster-meta">${movie.type_name || '未知类型'} • ${movie.vod_remarks || ''}</div>
                            </div>
                        </div>
                    `;
                });
                
                grid.innerHTML = html;
                
                document.querySelectorAll('.poster-item').forEach(item => {
                    item.addEventListener('click', async () => {
                        const vodId = item.getAttribute('data-id');
                        await this.showDetailModal(vodId);
                    });
                });
            }

            static getInitials(text) {
                return text.substring(0, 4);
            }

            static truncateText(text, maxLength) {
                return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
            }

            static async showDetailModal(vodId) {
                const modal = document.getElementById('detail-modal');
                const modalContent = document.getElementById('modal-content');
                const modalTitle = document.getElementById('modal-title');
                
                modalContent.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>正在加载详情...</p>
                    </div>
                `;
                
                modalTitle.textContent = '加载中...';
                modal.style.display = 'flex';
                
                try {
                    const data = await VodApiClient.fetchDetail(vodId);
                    if (data.code === 1 && data.list.length > 0) {
                        const movie = data.list[0];
                        await this.renderDetailContent(movie);
                    } else {
                        modalContent.innerHTML = '<p>未找到影视详情</p>';
                        modalTitle.textContent = '错误';
                    }
                } catch (error) {
                    console.error('Error loading detail:', error);
                    modalContent.innerHTML = `<p>加载失败: ${error.message}</p>`;
                    modalTitle.textContent = '错误';
                }
            }

            static async renderDetailContent(movie) {
                const modalContent = document.getElementById('modal-content');
                const modalTitle = document.getElementById('modal-title');
                
                modalTitle.textContent = movie.vod_name;
                
                const sources = VodApiClient.parsePlaySources(movie.vod_play_from, movie.vod_play_url);
                
                let sourcesHtml = '';
                sources.forEach((source, index) => {
                    sourcesHtml += `
                        <div class="source-item" data-url="${encodeURIComponent(source.url)}" data-name="${source.name}" data-title="${source.title}" data-type="${source.type}">
                            <div class="source-name">${source.name} - ${source.title}</div>
                            <div class="source-desc">类型: ${source.type === 'movie' ? '电影' : source.type === 'episode' ? '剧集' : '直链'}</div>
                            <div class="source-url">${this.truncateText(source.url, 60)}</div>
                        </div>
                    `;
                });
                
                if (sources.length === 0) {
                    sourcesHtml = '<p>暂无可用播放源</p>';
                }
                
                modalContent.innerHTML = `
                    <div class="detail-container">
                        <div class="poster-large">${this.getInitials(movie.vod_name)}</div>
                        <div class="detail-info">
                            <h2 class="detail-title">${movie.vod_name}</h2>
                            <div class="detail-meta">
                                类型: ${movie.type_name || '未知'} • 状态: ${movie.vod_remarks || '未知'} • 年份: ${movie.vod_year || '未知'}
                            </div>
                            <div class="sources-list">
                                <h3 class="sources-title">可用播放源 (${sources.length})</h3>
                                ${sourcesHtml}
                            </div>
                            <div class="action-buttons">
                                <button class="btn btn-primary" id="generate-strm-btn" disabled>生成STRM文件</button>
                                <button class="btn btn-secondary" id="test-play-btn" disabled>测试播放</button>
                            </div>
                        </div>
                    </div>
                `;
                
                let selectedSource = null;
                document.querySelectorAll('.source-item').forEach(item => {
                    item.addEventListener('click', () => {
                        document.querySelectorAll('.source-item').forEach(i => i.classList.remove('selected'));
                        item.classList.add('selected');
                        selectedSource = {
                            url: decodeURIComponent(item.getAttribute('data-url')),
                            name: item.getAttribute('data-name'),
                            title: item.getAttribute('data-title'),
                            type: item.getAttribute('data-type')
                        };
                        document.getElementById('generate-strm-btn').disabled = false;
                        document.getElementById('test-play-btn').disabled = false;
                    });
                });
                
                document.getElementById('generate-strm-btn').addEventListener('click', async () => {
                    if (!selectedSource) {
                        alert('请先选择一个播放源！');
                        return;
                    }
                    
                    await this.generateStrmFile(movie, selectedSource);
                });
                
                document.getElementById('test-play-btn').addEventListener('click', () => {
                    if (!selectedSource) {
                        alert('请先选择一个播放源！');
                        return;
                    }
                    
                    this.testPlayUrl(selectedSource.url);
                });
            }

            static async generateStrmFile(movie, source) {
                try {
                    const isValid = await this.validateUrl(source.url);
                    if (!isValid) {
                        alert('播放地址无效或无法访问！');
                        return;
                    }
                    
                    const embyPath = StrmManager.generateEmbyCompatiblePath(movie);
                    const strmContent = StrmManager.generateStrmContent(source.url);
                    
                    const strmData = {
                        name: movie.vod_name,
                        type: movie.type_name,
                        source: source.name,
                        title: source.title,
                        url: source.url,
                        embyPath: embyPath,
                        content: strmContent,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    StrmManager.addStrmFile(strmData);
                    
                    alert(`STRM文件生成成功！\n保存路径: ${embyPath}`);
                    
                    document.getElementById('detail-modal').style.display = 'none';
                    
                } catch (error) {
                    console.error('Error generating STRM file:', error);
                    alert(`生成STRM文件失败: ${error.message}`);
                }
            }

            static async validateUrl(url) {
                try {
                    new URL(url);
                    
                    const validExtensions = ['.m3u8', '.mp4', '.mkv', '.avi', '.ts', 'm3u8', 'mp4'];
                    const lowerUrl = url.toLowerCase();
                    
                    return validExtensions.some(ext => lowerUrl.includes(ext));
                } catch (e) {
                    return false;
                }
            }

            static testPlayUrl(url) {
                const config = ConfigManager.getConfig();
                const playerScheme = config.playerScheme;
                
                if (playerScheme) {
                    try {
                        const encodedUrl = encodeURIComponent(url);
                        const playUrl = `${playerScheme}${encodedUrl}`;
                        window.location.href = playUrl;
                    } catch (e) {
                        console.error('Player scheme failed:', e);
                        this.openInBrowser(url);
                    }
                } else {
                    this.openInBrowser(url);
                }
            }

            static openInBrowser(url) {
                try {
                    const newTab = window.open('', '_blank');
                    if (newTab) {
                        newTab.document.write(`
                            <html>
                                <head>
                                    <title>播放: ${this.truncateText(url, 30)}</title>
                                    <style>
                                        body { margin: 0; background: #000; display: flex; justify-content: center; align-items: center; height: 100vh; }
                                        video { max-width: 90%; max-height: 90%; }
                                        .error { color: #ff4444; text-align: center; padding: 20px; }
                                    </style>
                                </head>
                                <body>
                                    <video controls autoplay>
                                        <source src="${url}" type="application/x-mpegURL">
                                        <source src="${url}" type="video/mp4">
                                        您的浏览器不支持视频播放
                                    </video>
                                    <script>
                                        const video = document.querySelector('video');
                                        video.addEventListener('error', function() {
                                            document.body.innerHTML = '<div class="error">播放失败: 该地址可能无效或需要特定播放器</div>';
                                        });
                                        video.play().catch(e => console.log('Autoplay failed:', e));
                                    </script>
                                </body>
                            </html>
                        `);
                        newTab.document.close();
                    } else {
                        alert('无法打开新窗口，请允许弹出窗口');
                    }
                } catch (e) {
                    alert('播放失败: ' + e.message);
                }
            }

            static renderStrmPage() {
                const list = document.getElementById('strm-list');
                const files = StrmManager.getStrmFiles();
                
                if (files.length === 0) {
                    list.innerHTML = `
                        <div class="loading">
                            <p>暂无STRM文件，先去生成一些吧！</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                files.forEach((file, index) => {
                    html += `
                        <div class="strm-item">
                            <div class="strm-title">${file.name} - ${file.title}</div>
                            <div class="strm-meta">
                                类型: ${file.type} • 源: ${file.source} • 生成时间: ${new Date(file.createdAt).toLocaleString()}
                            </div>
                            <div class="strm-url">播放地址: ${this.truncateText(file.url, 60)}</div>
                            <div class="strm-meta">EMBY路径: ${file.embyPath}</div>
                            <div class="strm-actions">
                                <button class="btn btn-secondary edit-strm-btn" data-index="${index}">编辑</button>
                                <button class="btn btn-secondary download-strm-btn" data-index="${index}">下载</button>
                                <button class="btn btn-secondary test-play-strm-btn" data-url="${encodeURIComponent(file.url)}">测试播放</button>
                            </div>
                        </div>
                    `;
                });
                
                list.innerHTML = html;
                
                document.querySelectorAll('.edit-strm-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const index = parseInt(btn.getAttribute('data-index'));
                        this.showEditStrmModal(index);
                    });
                });
                
                document.querySelectorAll('.download-strm-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const index = parseInt(btn.getAttribute('data-index'));
                        this.downloadStrmFile(index);
                    });
                });
                
                document.querySelectorAll('.test-play-strm-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const url = decodeURIComponent(btn.getAttribute('data-url'));
                        this.testPlayUrl(url);
                    });
                });
            }

            static showEditStrmModal(index) {
                const files = StrmManager.getStrmFiles();
                if (!files[index]) return;
                
                const file = files[index];
                const modal = document.getElementById('edit-strm-modal');
                
                document.getElementById('edit-strm-name').value = file.name;
                document.getElementById('edit-strm-url').value = file.url;
                document.getElementById('new-strm-url').value = '';
                document.getElementById('new-sources-container').style.display = 'none';
                document.getElementById('new-sources-list').innerHTML = '';
                document.getElementById('edit-modal-title').textContent = `编辑: ${file.name}`;
                
                modal.style.display = 'flex';
                
                document.getElementById('find-new-source-btn').onclick = async () => {
                    await this.findNewSourcesForStrm(file.name);
                };
                
                document.getElementById('save-strm-btn').onclick = () => {
                    const newUrl = document.getElementById('new-strm-url').value.trim() || file.url;
                    this.saveStrmChanges(index, newUrl);
                };
            }

            static async findNewSourcesForStrm(movieName) {
                const container = document.getElementById('new-sources-container');
                const listElement = document.getElementById('new-sources-list');
                
                container.style.display = 'block';
                listElement.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>正在搜索新源...</p>
                    </div>
                `;
                
                try {
                    const data = await VodApiClient.fetchResources(movieName, 1, 5);
                    
                    if (data.code === 1 && data.list.length > 0) {
                        let sourcesHtml = '';
                        let foundSources = false;
                        
                        for (const movie of data.list) {
                            if (movie.vod_name !== movieName) continue;
                            
                            const sources = VodApiClient.parsePlaySources(movie.vod_play_from, movie.vod_play_url);
                            if (sources.length > 0) foundSources = true;
                            
                            sources.forEach((source, index) => {
                                sourcesHtml += `
                                    <div class="source-item" style="margin-bottom: 10px; padding: 10px; background: #3a3a3a; border-radius: 4px; cursor: pointer;"
                                         data-url="${encodeURIComponent(source.url)}" 
                                         data-name="${source.name}" 
                                         data-title="${source.title}">
                                        <strong>${source.name}</strong> - ${source.title}<br>
                                        <small style="color: #64b5f6;">${this.truncateText(source.url, 70)}</small>
                                    </div>
                                `;
                            });
                        }
                        
                        if (foundSources) {
                            listElement.innerHTML = sourcesHtml;
                            
                            document.querySelectorAll('#new-sources-list .source-item').forEach(item => {
                                item.addEventListener('click', () => {
                                    const url = decodeURIComponent(item.getAttribute('data-url'));
                                    document.getElementById('new-strm-url').value = url;
                                });
                            });
                        } else {
                            listElement.innerHTML = '<p>未找到可用的新源</p>';
                        }
                    } else {
                        listElement.innerHTML = '<p>未找到相关影视资源</p>';
                    }
                } catch (error) {
                    console.error('Error finding new sources:', error);
                    listElement.innerHTML = `<p>搜索失败: ${error.message}</p>`;
                }
            }

            static async saveStrmChanges(index, newUrl) {
                const isValid = await this.validateUrl(newUrl);
                if (!isValid) {
                    alert('新的播放地址无效！');
                    return;
                }
                
                StrmManager.updateStrmFile(index, {
                    url: newUrl,
                    updatedAt: new Date().toISOString()
                });
                
                alert('STRM文件更新成功！');
                document.getElementById('edit-strm-modal').style.display = 'none';
                this.renderStrmPage();
            }

            static downloadStrmFile(index) {
                const files = StrmManager.getStrmFiles();
                if (!files[index]) return;
                
                const file = files[index];
                const blob = new Blob([file.content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = file.embyPath.split('/').pop();
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                URL.revokeObjectURL(url);
            }

            static downloadAllStrmFiles() {
                const files = StrmManager.getStrmFiles();
                if (files.length === 0) {
                    alert('没有STRM文件可下载！');
                    return;
                }
                
                if (typeof JSZip === 'undefined') {
                    alert('JSZip库加载失败，请刷新页面重试');
                    return;
                }
                
                const zip = new JSZip();
                
                files.forEach(file => {
                    const pathParts = file.embyPath.split('/');
                    const filename = pathParts.pop();
                    const directory = pathParts.join('/');
                    
                    if (directory) {
                        zip.folder(directory).file(filename, file.content);
                    } else {
                        zip.file(filename, file.content);
                    }
                });
                
                zip.generateAsync({ type: 'blob' }).then(function(content) {
                    const url = URL.createObjectURL(content);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `vod-strm-files-${new Date().toISOString().split('T')[0]}.zip`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }).catch(function(error) {
                    console.error('Error generating ZIP:', error);
                    alert('生成ZIP文件失败: ' + error.message);
                });
            }
        }

        // ======================
        // 页面导航
        // ======================
        class PageRouter {
            static init() {
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.navigateTo(item.getAttribute('data-page'));
                    });
                });
                
                document.getElementById('close-modal').addEventListener('click', () => {
                    document.getElementById('detail-modal').style.display = 'none';
                });
                
                document.getElementById('close-edit-modal').addEventListener('click', () => {
                    document.getElementById('edit-strm-modal').style.display = 'none';
                });
                
                document.getElementById('detail-modal').addEventListener('click', (e) => {
                    if (e.target === document.getElementById('detail-modal')) {
                        document.getElementById('detail-modal').style.display = 'none';
                    }
                });
                
                document.getElementById('edit-strm-modal').addEventListener('click', (e) => {
                    if (e.target === document.getElementById('edit-strm-modal')) {
                        document.getElementById('edit-strm-modal').style.display = 'none';
                    }
                });
                
                document.getElementById('download-all-btn').addEventListener('click', () => {
                    PageRenderer.downloadAllStrmFiles();
                });
                
                document.getElementById('refresh-strm-btn').addEventListener('click', () => {
                    PageRenderer.renderStrmPage();
                });
            }
            
            static navigateTo(page) {
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.toggle('active', item.getAttribute('data-page') === page);
                });
                
                document.getElementById('home-page').style.display = page === 'home' ? 'block' : 'none';
                document.getElementById('strm-page').style.display = page === 'strm' ? 'block' : 'none';
                document.getElementById('config-page').style.display = page === 'config' ? 'block' : 'none';
                
                if (page === 'home') {
                    this.loadHomePage();
                } else if (page === 'strm') {
                    PageRenderer.renderStrmPage();
                }
            }
            
            static async loadHomePage() {
                const grid = document.getElementById('poster-grid');
                grid.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>正在加载影视资源...</p>
                    </div>
                `;
                
                try {
                    const data = await VodApiClient.fetchResources('', 1, 20);
                    if (data.code === 1) {
                        PageRenderer.renderHomePage(data.list);
                    } else {
                        grid.innerHTML = `<p>加载失败: ${data.msg || '未知错误'}</p>`;
                    }
                } catch (error) {
                    console.error('Error loading home page:', error);
                    grid.innerHTML = `<p>加载失败: ${error.message}</p>`;
                }
            }
        }

        // ======================
        // 初始化应用
        // ======================
        document.addEventListener('DOMContentLoaded', async () => {
            ConfigManager.init();
            PageRouter.init();
            PageRouter.navigateTo('home');
        });
    </script>
</body>
</html>
